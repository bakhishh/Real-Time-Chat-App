@page
@model ChatApp.Pages.Admin.AdminPageModel
@using System.Security.Claims
@{
    ViewData["Title"] = "Admin Dashboard";
}

<style>
    :root {
        --admin-primary: #1e293b;
        --admin-accent: #3b82f6;
    }
    body { 
        background-color: #f1f5f9; 
        overflow: hidden; 
        position: fixed; 
        width: 100%;
        height: 100%;
    }

    .dashboard-wrapper {
        height: 100vh;
        display: flex;
        flex-direction: column;
        padding-top: 1.5rem;
        padding-bottom: 3.5rem;
    }

    .dashboard-row { height: 100%; overflow: hidden; }
    .card { border: none; border-radius: 12px; }
    .shadow-sm { box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1) !important; }

    .user-list-item { 
        border: 1px solid #e2e8f0 !important;
        margin-bottom: 8px;
        border-radius: 10px !important;
        background-color: #fff;
        padding: 10px !important;
        display: flex;
        justify-content: space-between;
        align-items: center;
        transition: 0.2s;
    }
    .user-list-item:hover { background-color: #f8fafc; cursor: pointer; }
    .user-list-item.active { background-color: #eff6ff !important; border-color: #3b82f6 !important; }

    .btn-custom {
        padding: 6px 12px;
        font-size: 0.8rem;
        font-weight: 600;
        border-radius: 8px;
        display: inline-flex;
        align-items: center;
        gap: 5px;
    }

    ::-webkit-scrollbar { width: 5px; }
    ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }

    /* --- MOBİL AYARLAR --- */
    @@media (max-width: 767.98px) {
        .dashboard-wrapper {
            padding-top: 0;
            padding-bottom: 0;
            height: 100dvh !important; 
        }
        .dashboard-row {
            display: block; 
            margin: 0 !important;
            padding: 0 !important;
            height: 100%;
        }
        .col-md-3, .col-md-5, .col-md-4 { padding: 0 !important; }

        #panel-users, #panel-chat, #panel-announcements {
            height: 100% !important;
            width: 100%;
            position: absolute;
            top: 0; left: 0;
            background-color: #f1f5f9;
            z-index: 10;
        }

        .card { border-radius: 0 !important; height: 100% !important; }
        
        #mobile-chat-view .card { display: flex; flex-direction: column; }
        #chat-messages { flex: 1 1 auto !important; min-height: 0 !important; }
        #chat-footer { flex: 0 0 auto !important; padding-bottom: env(safe-area-inset-bottom); }

        #panel-chat, #panel-announcements { display: none !important; }
        #panel-users { display: flex !important; z-index: 20; }
    }
</style>

<div class="container-fluid dashboard-wrapper">
    <div class="row dashboard-row px-2">
        
        <div id="panel-users" class="col-md-3 d-flex flex-column h-100">
            
            <div class="d-md-none bg-dark text-white p-3 d-flex justify-content-between align-items-center shadow-sm flex-shrink-0">
                <span class="font-weight-bold">Admin Dashboard</span>
                <button class="btn btn-warning btn-sm font-weight-bold" onclick="showMobilePanel('announcements')">
                    📢 Announcements
                </button>
            </div>

            <div class="card shadow-sm mb-3 text-white flex-shrink-0 d-none d-md-block" style="background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);">
                <div class="card-body py-3 text-center">
                    <h5 class="mb-0 font-weight-bold">@Model.WelcomeMessage</h5>
                </div>
            </div>

            <div class="card shadow-sm flex-grow-1 overflow-hidden d-flex flex-column mb-0">
                <div class="card-header bg-white py-3 border-bottom flex-shrink-0">
                    <h6 class="mb-0 font-weight-bold text-primary">Users List</h6>
                </div>
                <div class="card-body bg-light flex-grow-1 overflow-auto">
                    @if (Model.Users.Any())
                    {
                        @foreach (var user in Model.Users)
                        {
                            <div class="user-list-item shadow-sm" data-user-id="@user.Id" data-user-name="@user.Username">
                                <div class="user-info text-truncate">
                                    <div class="font-weight-bold" style="font-size: 0.9rem;">@user.FirstName @user.LastName</div>
                                    <small class="text-muted">@@@user.Username</small>
                                </div>
                                <div class="user-actions d-flex gap-1 ml-2">
                                    <button class="btn btn-primary btn-custom update-user-btn px-2" data-user-id="@user.Id" title="Update">Upd
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="btn btn-outline-danger btn-custom delete-user-btn px-2" data-user-id="@user.Id" title="Delete">Del
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                        }
                    }
                </div>
                
                <div class="card-footer bg-white flex-shrink-0 pb-2">
                    <a asp-page="./AddUser" class="btn btn-success btn-block font-weight-bold py-2 shadow-sm mb-2">
                        <i class="fas fa-plus-circle mr-1"></i> Add New User
                    </a>

                    <div class="d-md-none d-flex gap-2">
                        <a asp-page="/Account/ChangePassword" class="btn btn-dark flex-grow-1 font-weight-bold py-2 shadow-sm">
                            <i class="fas fa-key"></i> Change Password
                        </a>
                        <form method="get" asp-page="/Account/Logout" class="flex-grow-1 m-0">
                            @Html.AntiForgeryToken()
                            <button type="submit" class="btn btn-danger btn-block font-weight-bold py-2 shadow-sm">
                                <i class="fas fa-sign-out-alt"></i> Logout
                            </button>
                        </form>
                    </div>
                    </div>
            </div>
        </div>

        <div id="panel-chat" class="col-md-5 d-flex flex-column h-100 px-md-3 px-0">
            <div class="card shadow-sm h-100 d-flex flex-column">
                
                <div id="chat-header" class="card-header bg-dark text-white py-3 flex-shrink-0 d-flex align-items-center justify-content-between">
                    
                    <button class="btn btn-light btn-sm d-md-none flex-shrink-0 font-weight-bold shadow-sm px-3" 
                            onclick="showMobilePanel('users')"
                            style="color: #333;"> 
                        <i class="fas fa-arrow-left mr-1"></i> Back
                    </button>

                    <h6 id="chat-title" class="mb-0 font-weight-bold text-truncate text-right pl-3">
                        Select a user to chat...
                    </h6>
                </div>
                
                <div id="chat-messages" class="card-body bg-white flex-grow-1 overflow-auto" style="min-height: 0;">
                    <div id="empty-chat-message" class="text-center text-muted mt-5">
                        <p>Click on a user to open chat history.</p>
                    </div>
                </div>
                
                <div id="chat-footer" class="card-footer bg-white d-none border-top flex-shrink-0 p-3">
                    <div class="input-group">
                        <input type="text" id="message-input" class="form-control border-right-0" placeholder="Type a message..." 
                               style="height: 45px; border-radius: 8px 0 0 8px; border-color: #ced4da;">
        
                        <div class="input-group-append">
                            <button id="send-button" class="btn btn-primary px-4 font-weight-bold" type="button" 
                                    style="height: 45px; border-radius: 0 8px 8px 0; display: flex; align-items: center;">
                                <i class="fas fa-paper-plane mr-2"></i> Send
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="panel-announcements" class="col-md-4 d-flex flex-column h-100">
            
            <div class="d-md-none bg-warning p-3 d-flex align-items-center justify-content-between mb-0 flex-shrink-0">
                <button class="btn btn-sm btn-light font-weight-bold shadow-sm" onclick="showMobilePanel('users')">
                    <i class="fas fa-arrow-left mr-1"></i> Back
                </button>
                <span class="font-weight-bold text-dark">Announcements</span>
            </div>

            <div class="card shadow-sm border-warning flex-grow-1 overflow-hidden d-flex flex-column mb-0">
                <div class="card-header bg-warning text-dark font-weight-bold py-3 flex-shrink-0 d-none d-md-block">
                    📢 Announcements Management
                </div>
                <div class="card-body flex-grow-1 overflow-auto">
                    <form method="post" asp-page-handler="PublishAnnouncement">
                        @Html.AntiForgeryToken()
                        <div class="form-group mb-2">
                            <input asp-for="AnnouncementInput.Title" class="form-control" placeholder="Announcement Title" />
                            <span asp-validation-for="AnnouncementInput.Title" class="text-danger small"></span>
                        </div>
                        <div class="form-group mb-2">
                            <textarea asp-for="AnnouncementInput.Content" class="form-control" rows="3" placeholder="Write a new announcement..."></textarea>
                            <span asp-validation-for="AnnouncementInput.Content" class="text-danger small"></span>
                        </div>
                        <button type="submit" class="btn btn-warning btn-block font-weight-bold shadow-sm">Publish Announcement</button>
                    </form>

                    <h6 class="mt-4 border-bottom pb-1 font-weight-bold small text-muted">Latest History:</h6>
                    <div class="list-group list-group-flush">
                        @if (Model.LatestAnnouncements != null && Model.LatestAnnouncements.Any())
                        {
                            @foreach (var announcement in Model.LatestAnnouncements)
                            {
                                <div class="list-group-item list-group-item-light small p-2 mb-2 border rounded d-flex justify-content-between align-items-center shadow-xs" data-announcement-id="@announcement.Id">
                                    <div class="mr-2 overflow-hidden">
                                        <div class="font-weight-bold text-primary">@announcement.Title</div>
                                        <div class="text-dark">@announcement.Content</div>
                                        <small class="text-muted">@announcement.Date.ToString("dd MMM HH:mm")</small>
                                    </div>
                                    <form method="post" asp-page-handler="DeleteAnnouncement" asp-route-id="@announcement.Id" class="delete-announcement-form">
                                        @Html.AntiForgeryToken()
                                        <button type="submit" class="btn btn-outline-danger btn-custom shadow-sm d-inline-flex align-items-center justify-content-center" style="padding: 0.25rem 0.5rem; gap: 4px;">Del
                                            <i class="fa fa-trash"></i> 
                                            </button>
                                    </form>
                                </div>
                            }
                        }
                    </div>
                </div>
            </div>

            <div class="mt-3 d-none d-md-flex gap-2 flex-shrink-0 pb-2">
                <a asp-page="/Account/ChangePassword" class="btn btn-dark font-weight-bold flex-grow-1 py-2 shadow-sm mr-2">
                    <i class="fas fa-key mr-1"></i> Change Password
                </a>
                
                <form method="get" asp-page="/Account/Logout" class="flex-grow-1 m-0">
                    @Html.AntiForgeryToken()
                    <button type="submit" class="btn btn-danger btn-block font-weight-bold py-2 shadow-sm">
                        <i class="fas fa-sign-out-alt mr-1"></i> Logout
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    @{ await Html.RenderPartialAsync("_ValidationScriptsPartial"); }
    
    <script src="~/lib/signalr/dist/browser/signalr.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script>
        const CURRENT_USER_ID = '@(User.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value ?? "0")';
        var connection = null;
        var currentTargetId = null; 

        function getAntiForgeryToken() {
            return $('input[name="__RequestVerificationToken"]').val();
        }

        // MOBİL GÖRÜNÜM GEÇİŞLERİ
        function showMobilePanel(panelName) {
            if ($(window).width() >= 768) return;

            $('#panel-users').attr('style', 'display: none !important');
            $('#panel-chat').attr('style', 'display: none !important');
            $('#panel-announcements').attr('style', 'display: none !important');

            if (panelName === 'users') {
                $('#panel-users').attr('style', 'display: flex !important');
            } 
            else if (panelName === 'chat') {
                $('#panel-chat').attr('style', 'display: flex !important');
                if(currentTargetId) { $('#chat-footer').removeClass('d-none'); }
            } 
            else if (panelName === 'announcements') {
                $('#panel-announcements').attr('style', 'display: flex !important');
            }
        }

        
        function startSignalR() {
            connection = new signalR.HubConnectionBuilder().withUrl("/chatHub").build();
            connection.on("ReceiveMessage", function (senderId, senderUsername, messageContent, time) {
                if (senderId == currentTargetId || senderId == CURRENT_USER_ID) { 
                    $('#no-history-message').remove();
                    addMessageToChat(senderId, messageContent, time, senderUsername);
                }
            });

            // DUYURU ALINDIĞINDA (SignalR)
            connection.on("ReceiveAnnouncement", function (title, content, date, id) {
                var token = getAntiForgeryToken();
                const announcementHtml = `
                    <div class="list-group-item list-group-item-light small p-2 mb-2 border rounded d-flex justify-content-between align-items-center shadow-xs" data-announcement-id="${id}" style="display:none;">
                        <div class="mr-2 overflow-hidden">
                            <div class="font-weight-bold text-primary">${title}</div>
                            <div class="text-dark">${content}</div>
                            <small class="text-muted">${date}</small>
                        </div>
                        <form method="post" action="?handler=DeleteAnnouncement&id=${id}" class="delete-announcement-form">
                            <input type="hidden" name="__RequestVerificationToken" value="${token}">
                            <button type="submit" class="btn btn-outline-danger btn-custom shadow-sm" style="padding: 0.25rem 0.5rem;"><i class="fa fa-trash"></i></button>
                        </form>
                    </div>`;
                const list = $('.list-group.list-group-flush').last(); 
                list.prepend(announcementHtml); list.children().first().fadeIn(1000);
            });

            connection.on("RemoveAnnouncement", function (id) {
                var el = $(`.list-group-item[data-announcement-id='${id}']`);
                if (!el.length) el = $(`form[action*='id=${id}']`).closest('.list-group-item');
                el.fadeOut(300, function() { $(this).remove(); });
            });
            connection.start().catch(err => setTimeout(startSignalR, 5000));
        }

        function addMessageToChat(senderId, content, time, senderUsername) {
            var isSentByMe = (senderId == CURRENT_USER_ID);
            var chatBody = $('#chat-messages');
            var messageHtml = `
                <div class="d-flex ${isSentByMe ? 'justify-content-end' : 'justify-content-start'} mb-3">
                    <div class="card p-2 shadow-sm ${isSentByMe ? 'bg-info text-white' : 'bg-light text-dark'}" style="max-width: 70%;">
                        <div class="small font-weight-bold ${isSentByMe ? 'text-right text-white' : 'text-left text-muted'}">
                            ${isSentByMe ? 'You (Admin)' : senderUsername}
                        </div>
                        <div>${content}</div>
                        <div class="small ${isSentByMe ? 'text-right text-white-50' : 'text-left text-muted'}">${time}</div>
                    </div>
                </div>`;
            $('#chat-messages .alert-info').remove();
            chatBody.append(messageHtml);
            chatBody.scrollTop(chatBody.prop("scrollHeight"));
        }
        
        function loadChatHistory(userId) {
            var chatBody = $('#chat-messages');
            chatBody.html('<div class="alert alert-info p-2 text-center">Loading...</div>');
            $.ajax({
                url: `?handler=ChatHistory&targetId=${userId}`,
                type: 'GET',
                success: function(response) {
                    chatBody.empty();
                    if (response.success && response.messages.length > 0) {
                        response.messages.forEach(msg => {
                            var senderName = msg.isSender ? 'You (Admin)' : msg.senderUsername || 'Contact';
                            addMessageToChat(msg.isSender ? CURRENT_USER_ID : userId, msg.content, msg.time, senderName);
                        });
                    } else {
                        chatBody.html('<div id="no-history-message" class="text-center text-muted mt-5">No message history yet.</div>');
                    }
                }
            });
        }

        $(document).ready(function () {
            startSignalR();

            $('#send-button').on('click', function(e) {
                e.preventDefault(); 
                
                var msgInput = $('#message-input');
                var messageContent = msgInput.val().trim();
                
                if (messageContent && currentTargetId && connection.state === "Connected") {
                    connection.invoke("SendMessage", currentTargetId, messageContent)
                        .then(() => { 
                            msgInput.val('');
                            setTimeout(function() { 
                                msgInput.focus(); 
                            }, 10);
                        })
                        .catch(err => console.error(err));
                }
                msgInput.focus();
            });
            
            $('#message-input').keypress(function (e) {
                if (e.which == 13) { e.preventDefault(); $('#send-button').click(); }
            });

            $('.user-list-item').on('click', function(e) {
                if (!$(e.target).closest('.user-actions').length) {
                    e.preventDefault();
                    var userName = $(this).data('user-name');
                    currentTargetId = $(this).data('user-id');
                    
                    $('#chat-title').text(userName);
                    $('#chat-footer').removeClass('d-none');
                    $('.user-list-item').removeClass('active');
                    $(this).addClass('active');
                    loadChatHistory(currentTargetId);

                    showMobilePanel('chat');
                }
            });

            // KULLANICI SİLME (SweetAlert2)
            $('.delete-user-btn').on('click', function (e) {
                e.preventDefault(); 
                e.stopPropagation();
                
                var userId = $(this).data('user-id'); 

                Swal.fire({
                    title: 'Delete User?',
                    text: "You are about to delete this user! This cannot be undone.",
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#d33', 
                    cancelButtonColor: '#3085d6', 
                    confirmButtonText: 'Yes, delete!',
                    cancelButtonText: 'Cancel'
                }).then((result) => {
                    if (result.isConfirmed) {
                        $.ajax({
                            url: `?handler=DeleteUser&id=${userId}`,
                            type: 'POST',
                            headers: { 'RequestVerificationToken': getAntiForgeryToken() },
                            success: function () {
                                Swal.fire(
                                    'Deleted!',
                                    'The user has been deleted.',
                                    'success'
                                ).then(() => {
                                    location.reload();
                                });
                            },
                            error: function () { 
                                Swal.fire('Error!', 'Something went wrong.', 'error');
                            }
                        });
                    }
                });
            });

            // DUYURU SİLME (SweetAlert2 - Event Delegation)
            $(document).on('submit', '.delete-announcement-form', function (e) {
                e.preventDefault(); 
                
                var form = this;
                var actionUrl = $(form).attr('action'); 
                var formData = $(form).serialize(); 
                
                Swal.fire({
                    title: 'Delete Announcement?',
                    text: "Are you sure you want to delete this announcement?",
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#d33',
                    cancelButtonColor: '#3085d6',
                    confirmButtonText: 'Yes, delete it!'
                }).then((result) => {
                    if (result.isConfirmed) {
                        $.ajax({
                            url: actionUrl,
                            type: 'POST',
                            data: formData,
                            success: function () {
                                Swal.fire(
                                    'Deleted!',
                                    'The announcement has been deleted.',
                                    'success'
                                ).then(() => {
                                    location.reload();
                                });
                            },
                            error: function () {
                                Swal.fire('Error!', 'Could not delete announcement.', 'error');
                            }
                        });
                    }
                });
            });

            $('.update-user-btn').on('click', function (e) {
                e.preventDefault(); e.stopPropagation();
                window.location.href = `./UpdateUser/${$(this).data('user-id')}`;
            });
        });
    </script>
}